<?xml version="1.0" encoding="EUC-JP"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja">

<head>
<meta charset="UTF-8">
<title>SoraMame Script</title>
	<script type="text/javascript" src="../../processing-1.4.1.js"></script>
	<script type="text/javascript" src="../../parse.js"></script>
	<script type="text/javascript" src="../../lib_command.js"></script>
	<script type="text/javascript" src="../../soramame.js"></script>
</head>


<body onLoad="soramame_init()">
<h1>SoraMame Script(そら豆スクリプト) - 日本語っぽいプログラミング言語</h1>
日本語っぽいコードを、プログラミング言語Processing.jsに変換して実行します(SoraMame.ps.js)。
<hr />

<table width="960px" heiht="320px" bgcolor="#eeeeee"><tbody><tr> 
  <td width="320px" height="320px" bgcolor="white"> 
		<canvas id="canvas0" width="320px" height="320px"></canvas> 
  </td>	
  <td>
  <form name="compiledtext" id="compiledtext" onsubmit="return main()">
	<textarea id="source" cols="80" rows="20">
//横スクロール型デモ
//Copyright 2012 Yutaka Kachi
//MIT License

/* @pjs preload="space_tunnel/dot.gif"; */
/* @pjs preload="space_tunnel/enemy.gif"; */
/* @pjs preload="space_tunnel/ship.gif"; */

@開始フラグは正否型 = @否

@天井yは整数型
@床面yは整数型

@星_個数は整数型 = 20
@星は星型[] = 新しい星型[@星_個数]

@敵_個数は整数型 = 8
@敵は敵型[] = 新しい敵型[@敵_個数]

@星イメージはPイメージ型
@敵イメージはPイメージ型
@船イメージはPイメージ型

---初期設定する{
    {幅:300, 高さ:300}のサイズ
    @天井y = 60
    @床面y = @高さ - 80

    {開始:@iは整数型 = 0 , 条件:@i < @星_個数 ,変化:@i += 1}のくりかえし{
        @星[@i] = 新しい星型
    }
    {開始:@iは整数型 = 0 , 条件:@i < @敵_個数 ,変化:@i += 1}のくりかえし{
        @敵[@i] = 新しい敵型
    }

    @星イメージ = {ファイル:「space_tunnel/dot.gif」}でイメージ読み込みする
    @敵イメージ = {ファイル:「space_tunnel/enemy.gif」}でイメージ読み込みする
    @船イメージ = {ファイル:「space_tunnel/ship.gif」}でイメージ読み込みする

    {色:0}の背景色
    画面表示する
    {R:255, G:0, B:0}の塗りつぶし色
    {もじ:「<Click to Start!>」}で{X:@幅 / 3, Y:@床面y + 60}にもじ表示する
}

---くり返し描画する{

    もし{条件:@開始フラグ == @正}ならば{
    {色:0}の背景色
    トンネル調整する
	
    {開始:@iは整数型 = 0 , 条件:@i < @星_個数 ,変化:@i += 1}のくりかえし{
        @星[@i]を移動する
        @星[@i]を描く
    }
    {開始:@iは整数型 = 0 , 条件:@i < @敵_個数 ,変化:@i += 1}のくりかえし{
        @敵[@i]を移動する
        @敵[@i]を描く
    }
    画面表示する
	船表示する
  }
}

---画面表示する{

	//上下の余白
    {色:255}の塗りつぶし色
    {色:255}の輪郭色
    {x:0, y:0}に{幅:@幅, 高さ:@天井y - 25}のシカク
    {x:0, y:@床面y + 25}に{幅:@幅, 高さ:@高さ}のシカク

	//上下のバー
    {R:0, G:120, B:120}の塗りつぶし色
    輪郭なし
    {x:0, y:@天井y - 10}に{幅:@幅, 高さ:10}のシカク
    {x:0, y:@床面y}に{幅:@幅, 高さ:10}のシカク

	//バー上面の明るい線
    {R:0, G:200, B:200}の輪郭色
    {x:0, y:@天井y - 10}に{幅:@幅, 高さ:@天井y - 10}のセン
    {x:0, y:@床面y}に{幅:@幅, 高さ:@床面y}のセン
	
	//バー下面の明るい線
    {R:70, G:70, B:70}の輪郭色
    {x:0, y:@天井y}に{幅:@幅, 高さ:@天井y}のセン
    {x:0, y:@床面y + 10}に{幅:@幅, 高さ:@床面y + 10}のセン

	//上部タイトル
    {R:0, G:120, B:120}の塗りつぶし色
    {もじ:「Space Tunnel」}で{X:@幅 / 3 + 10, Y:10}にもじ表示する

    //ドラッグエリア
    塗りつぶしなし
    {R:0, G:200, B:200}の輪郭色
    {x:5, y:@床面y + 30}に{幅:@幅 - 10, 高さ:@高さ - @床面y - 35 }のシカク
}

---クリック時{
    @開始フラグ = @正
}

---船表示する{
    @クリック領域y = @床面y + 25
    もし{条件:@マウスy < @クリック領域y}ならば{
        @マウスy2 = 0
    } ちがえば {
        @マウスy2 = @マウスy - @クリック領域y
    }
    @船位置y =  @マウスy2 / (@高さ  - @クリック領域y) * (@床面y - 12 - @天井y ) + @天井y
    {対象:@船イメージ}で{x:@マウスx, y:@船位置y}にイメージ表示する
}
---トンネル調整する{

    @天井差分y = (@幅/2 - @マウスx) / @幅 * 30
    @天井y = 60 + @天井差分y

	@床面差分y = (@幅/2 - @マウスx) / @幅 * 30
	@床面y = @高さ - 80 - @床面差分y
}

===星型{
   @位置xは実数型
   @位置yは実数型

   @速度は実数型

+++星型{
    初期化する
	@位置x = {下限:@幅, 上限：@幅 * 2}の乱数
  }

---移動する{
     @位置x -= @速度
     もし{条件:@位置x <= 0}ならば{
         初期化する
     }
  }

---描く{
    もし{条件:(@位置y >= @天井y)&&(@位置y <= @床面y)}ならば{
        {対象:@星イメージ}で{x:@位置x, y:@位置y}にイメージ表示する
    }
  }

---初期化する{
    @位置x = @幅
    @位置y = {下限:@天井y, 上限：@床面y}の乱数
    @速度 = {上限:1}の乱数 + 1
  }
}

===敵型{
   @位置xは実数型
   @位置yは実数型

   @速度xは実数型
   @速度yは実数型
   @方向yは整数型

+++敵型{
    初期化する
	@位置x = {下限:@幅, 上限：@幅 * 2}の乱数
  }

---移動する{
     @位置x -= @速度x
     もし{条件:@位置x <= -20}ならば{
         初期化する
     }
     @位置y += @方向y * @速度y
     もし{条件:@位置y < @天井y}ならば{
         @方向y = 1
     }
     もし{条件:@位置y > @床面y - 14}ならば{
         @方向y = -1
     }
  }

---描く{
    {対象:@敵イメージ}で{x:@位置x, y:@位置y}にイメージ表示する
  }

---初期化する{
    @位置x = @幅
    @位置y = {下限:@天井y, 上限：@床面y - 14}の乱数
    @速度x = {上限:1}の乱数 + 1
    @速度y = {上限:0.5}の乱数 + 0.2

    @方向y = 1
    もし{条件:{上限:10}の乱数 > 5}ならば{
         @方向y = -1
    }
  }
}
</textarea><br />
	<input type="button" value="わける" onclick="soramame_lex()" />
	<input type="button" value="へんかん" onclick="soramame_parse()" />
	<input type="button" value="うごかす" onclick="soramame_exec()" />
	<input type="button" value="とめる" onclick="soramame_stop()" />
	<br />
	<input type="file" id="myFile" onchange="file_open()" />
	[<a href="#" id="download-link" >ほぞん</a>]
	[<a href="http://www.catch.jp/wiki/?SoraMame.ps.js" target='_blannk'>ヘルプ?</a>]
  </form>
  </td>
  </tr></tbody></table>  
<hr>
<h2>変換結果</h2>
<pre id="screen"></pre>

<div id="result"></div> 
</body>

</html>


<script type="text/javascript">
<!--
var sora;
var yylval = '';
var Pjs;
var lib_dic = new lib_dic();	//コマンド置換辞書

function soramame_exec(){
  var Esource = document.getElementById("source");
  sora = new soramame(Esource.value);
  var script = yyparse();
  sora.debug(script);

  soramame_stop();
　　var canvas = document.getElementById('canvas0');
  try{
    Pjs = new Processing(canvas, script);
  }catch(e){
    alert(e);
  }
　　return false;
}

function soramame_stop(){
    if (Pjs)
      Pjs.exit();
}


function soramame_lex(){
  var Esource = document.getElementById("source");
  sora = new soramame(Esource.value);

  var type;
  var retval;
  var i = 0;
  while(retval = yylex()){
    switch(retval){
	case COMMENT:
      type = "COMMENT";
      break;
    case NUMBER:
      type = "NUMBER";
      break;
    case STRING:
      type = "STRING";
      break;
	case DEF_FUNC:
      type = "DEF_FUNC";
      break;
	case DEF_CLASS:
      type = "DEF_CLASS";
      break;
	case DEF_CLASS_INIT:
      type = "DEF_CLASS_INIT";
      break;
	case IF:
      type = "IF";
      break;
	case THEN:
      type = "THEN";
      break;
	case ELSE:
      type = "ELSE";
      break;
	case LOOP:
      type = "LOOP";
      break;
	case NEW:
      type = "NEW";
      break;
	case JOSI:
      type = "JOSI";
      break;
	case JOSI_HA:
      type = "JOSI_HA";
      break;
	case JOSI_NO:
      type = "JOSI_NO";
      break;
	case JOSI_WO:
      type = "JOSI_WO";
      break;
    case WORD:
      type = "WORD";
      break;
    default:
      type = retval;
      break;
    }
    sora.debug(type+": "+yylval);
    if(i++ > 300){
      break;
    }
  }
}


function yylex(){
  var retval = sora.yylex();
  yylval = sora.yylval;
  return retval;
}


function yyerror(str){
  sora.debug(str);
}

function soramame_parse(){
  var Esource = document.getElementById("source");
  sora = new soramame(Esource.value);
  var script = yyparse();
  sora.debug(script);
 
}

function soramame_init() {
	if (window.File) {
		//window.alert("File API OK.");
	} else {
		window.alert("このWebブラウザは、そら豆スクリプトに未対応かも。\n FirefoxやGoogleChromeなどをお試しください");
	}
}

//テキストファイルを読み込む
function file_open() {
	var fileData = document.getElementById("myFile").files[0];	
	var reader = new FileReader();
	reader.onload = function(evt){
		document.getElementById("source").innerHTML = evt.target.result; // 内容をページ上に表示         
	}
	reader.readAsText(fileData, "utf-8"); // 文字コードをUTF-8として読み込む
}

//テキストファイルを保存する
window.onload = function() {
	document.getElementById("download-link").addEventListener("click", function(){
		var value = document.getElementById("source").innerHTML;
		var href = "data:application/octet-stream," + encodeURIComponent(value);
		this.setAttribute("href", href);
	}, false);
}
//-->
</script>

